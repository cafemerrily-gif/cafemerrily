<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="å­¦ç”Ÿã‚«ãƒ•ã‚§ã®ç·åˆç®¡ç†ãƒ„ãƒ¼ãƒ« - ä¼šè¨ˆãƒ»é–‹ç™ºãƒ»åºƒå ±ã‚’ä¸€å…ƒç®¡ç†">
  <meta name="theme-color" content="#2D8B5F">
  <link rel="manifest" href="./manifest.json">
  <title>MERRILY ã‚«ãƒ•ã‚§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ä¼šè¨ˆåˆ†æç‰ˆ</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --merrily-green: #2D8B5F;
      --merrily-green-light: #E8F5E9;
      --merrily-green-dark: #1a5a3a;
      --merrily-brown: #8B3A3A;
      --merrily-brown-light: #FFF3E0;
      --merrily-yellow: #DAA520;
      --merrily-yellow-light: #FFF9E6;
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --bg-card: #FFFFFF;
      --text-primary: #2C3E50;
      --text-secondary: #7F8C8D;
      --border-color: #E0E0E0;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 16px rgba(0,0,0,0.12);
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    h1, h2, h3 { font-family: 'Playfair Display', serif; font-weight: 600; }

    .error-message, .success-message, .debug-info, .warning-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    .error-message { background: #fee; color: #c00; border: 1px solid #fcc; white-space: pre-wrap; }
    .success-message { background: #e8f5e9; color: #2e7d32; border: 1px solid #81c784; }
    .warning-message { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .debug-info { background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }

    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--merrily-green-light) 0%, var(--merrily-yellow-light) 100%);
      padding: 20px;
    }

    .login-card {
      background: var(--bg-card);
      border-radius: 24px;
      box-shadow: var(--shadow-hover);
      padding: 48px;
      max-width: 550px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .logo-container { text-align: center; margin-bottom: 32px; }
    .logo-text {
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--merrily-green) 0%, var(--merrily-brown) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
    }
    .logo-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .form-group { margin-bottom: 20px; }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 14px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 15px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Noto Sans JP', sans-serif;
      transition: all 0.3s ease;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--merrily-green);
      box-shadow: 0 0 0 3px var(--merrily-green-light);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Noto Sans JP', sans-serif;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--merrily-green) 0%, var(--merrily-green-dark) 100%);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(45, 139, 95, 0.3);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-success {
      padding: 12px 24px;
      background: var(--merrily-green);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary {
      padding: 10px 20px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-danger {
      padding: 10px 20px;
      background: var(--merrily-brown);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }

    .dashboard { display: flex; min-height: 100vh; }
    
    .sidebar {
      width: 280px;
      background: var(--bg-card);
      border-right: 1px solid var(--border-color);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border-color); }
    .sidebar-logo {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--merrily-green) 0%, var(--merrily-brown) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .user-info {
      margin-top: 16px;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--merrily-green) 0%, var(--merrily-yellow) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
    }

    .sidebar-nav { flex: 1; padding: 16px; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      padding: 0 12px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 4px;
    }
    .nav-item:hover { background: var(--merrily-green-light); }
    .nav-item.active { background: var(--merrily-green); color: white; }

    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border-color); }

    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 32px;
      overflow-y: auto;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .page-title {
      font-size: 32px;
      color: var(--text-primary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .stat-change {
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .stat-change.positive {
      color: var(--merrily-green-dark);
      background: var(--merrily-green-light);
    }

    .stat-change.negative {
      color: var(--merrily-brown);
      background: var(--merrily-brown-light);
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .chart-container {
      position: relative;
      height: 350px;
      margin-top: 16px;
    }

    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table thead {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-color);
    }

    .table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
      white-space: nowrap;
    }

    .table td {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }

    .table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success {
      background: var(--merrily-green-light);
      color: var(--merrily-green-dark);
    }

    .badge-warning {
      background: var(--merrily-yellow-light);
      color: #8B6914;
    }

    .badge-danger {
      background: var(--merrily-brown-light);
      color: var(--merrily-brown);
    }

    .filter-group {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-item {
      flex: 1;
      min-width: 200px;
    }

    .loading {
      text-align: center;
      padding: 48px;
      color: var(--text-secondary);
      font-size: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 64px 32px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 20px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 32px;
      color: var(--text-secondary);
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 32px;
      height: 32px;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      max-height: 400px;
      overflow-y: auto;
      padding: 8px;
    }

    .product-card {
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .product-card:hover {
      border-color: var(--merrily-green);
      background: var(--merrily-green-light);
      transform: translateY(-2px);
    }

    .product-card.selected {
      border-color: var(--merrily-green);
      background: var(--merrily-green-light);
    }

    .product-name {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .product-price {
      color: var(--merrily-green-dark);
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 12px;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: var(--merrily-green);
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .quantity-btn:hover {
      background: var(--merrily-green-dark);
      transform: scale(1.1);
    }

    .quantity-input {
      width: 60px;
      padding: 8px;
      text-align: center;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
    }

    .summary-box {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-top: 24px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 16px;
    }

    .summary-row.total {
      border-top: 2px solid var(--border-color);
      margin-top: 12px;
      padding-top: 20px;
      font-size: 20px;
      font-weight: 700;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
    }

    .tab-button {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      position: relative;
      bottom: -2px;
    }

    .tab-button:hover {
      color: var(--merrily-green);
    }

    .tab-button.active {
      color: var(--merrily-green);
      border-bottom-color: var(--merrily-green);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbzwB2nmbazcT6uQ5QJrL0P4cEO2iOZW8HDhm8mrlV-VUMC6meKi95ljFR81cDSi2lvicQ/exec';

    // ============================================
    // APIé€šä¿¡é–¢æ•°
    // ============================================

    async function apiCall(action, params = {}) {
      try {
        const sessionToken = localStorage.getItem('sessionToken');
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: action,
            sessionToken: sessionToken,
            ...params
          }),
          redirect: 'follow'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const contentType = response.headers.get('content-type');
        let data;
        
        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          console.log('Response text:', text);
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error('JSON parse error:', e);
            throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
          }
        }
        
        return data;
      } catch (error) {
        console.error('API Call Error:', error);
        throw error;
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('ja-JP', {
        style: 'currency',
        currency: 'JPY'
      }).format(amount);
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP');
    }

    // ============================================
    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    // ============================================

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        checkSession();
      }, []);

      const checkSession = async () => {
        const sessionToken = localStorage.getItem('sessionToken');
        
        if (!sessionToken) {
          setLoading(false);
          return;
        }

        try {
          const result = await apiCall('checkSession');
          
          if (result.success) {
            setUser(result.data.user);
          } else {
            localStorage.removeItem('sessionToken');
          }
        } catch (error) {
          console.error('Session check error:', error);
          localStorage.removeItem('sessionToken');
        } finally {
          setLoading(false);
        }
      };

      const handleLogin = (userData) => {
        setUser(userData);
      };

      const handleLogout = async () => {
        try {
          await apiCall('logout');
        } catch (error) {
          console.error('Logout error:', error);
        }
        
        localStorage.removeItem('sessionToken');
        setUser(null);
      };

      if (loading) {
        return (
          <div className="loading-container" style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
            <div className="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      if (!user) {
        return <LoginPage onLogin={handleLogin} />;
      }

      return <Dashboard user={user} onLogout={handleLogout} />;
    }

    // ============================================
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
    // ============================================

    function LoginPage({ onLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [apiStatus, setApiStatus] = useState(null);
      const [testingApi, setTestingApi] = useState(false);
      const [debugInfo, setDebugInfo] = useState('');

      const testApiConnection = async () => {
        setTestingApi(true);
        setApiStatus(null);
        setError('');
        setDebugInfo('');

        const debugLog = [];
        debugLog.push('=== APIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        debugLog.push(`ãƒ†ã‚¹ãƒˆæ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`);
        debugLog.push(`API URL: ${API_URL}`);
        debugLog.push('');

        try {
          debugLog.push('GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
          const response = await fetch(API_URL, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            redirect: 'follow'
          });

          debugLog.push(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} ${response.statusText}`);
          debugLog.push(`Content-Type: ${response.headers.get('content-type')}`);
          debugLog.push('');

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const contentType = response.headers.get('content-type');
          let data;
          
          if (contentType && contentType.includes('application/json')) {
            data = await response.json();
          } else {
            const text = await response.text();
            debugLog.push('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å—ä¿¡:');
            debugLog.push(text);
            try {
              data = JSON.parse(text);
            } catch (e) {
              throw new Error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
            }
          }
          
          debugLog.push('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:');
          debugLog.push(JSON.stringify(data, null, 2));

          setApiStatus('success');
          setDebugInfo(debugLog.join('\n'));
        } catch (error) {
          debugLog.push('');
          debugLog.push('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:');
          debugLog.push(`ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${error.message}`);
          if (error.stack) {
            debugLog.push(`ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ${error.stack}`);
          }
          
          setApiStatus('error');
          setError('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message);
          setDebugInfo(debugLog.join('\n'));
        } finally {
          setTestingApi(false);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);
        setDebugInfo('');

        const debugLog = [];
        debugLog.push('=== ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹ ===');
        debugLog.push(`ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œæ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`);
        debugLog.push(`ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${email}`);
        debugLog.push('');

        try {
          debugLog.push('ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
          const result = await apiCall('login', {
            email: email,
            password: password
          });

          debugLog.push('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:');
          debugLog.push(JSON.stringify(result, null, 2));

          if (result.success) {
            debugLog.push('');
            debugLog.push('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
            localStorage.setItem('sessionToken', result.data.sessionToken);
            onLogin(result.data.user);
          } else {
            debugLog.push('');
            debugLog.push('âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
            setError(result.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
            setDebugInfo(debugLog.join('\n'));
          }
        } catch (error) {
          debugLog.push('');
          debugLog.push('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:');
          debugLog.push(`ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${error.message}`);
          setError('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
          setDebugInfo(debugLog.join('\n'));
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <div className="logo-container">
              <div className="logo-text">MERRILY</div>
              <div className="logo-subtitle">Cafe Management System</div>
            </div>

            {API_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE' && (
              <div className="warning-message">
                âš ï¸ API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã€ŒYOUR_APPS_SCRIPT_WEB_APP_URL_HEREã€ã‚’å®Ÿéš›ã®Google Apps Scriptã®Web Appã®URLã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
              </div>
            )}

            <div style={{marginBottom: '16px'}}>
              <button 
                type="button"
                className="btn-secondary" 
                style={{width: '100%'}}
                onClick={testApiConnection}
                disabled={testingApi || API_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE'}
              >
                {testingApi ? 'ãƒ†ã‚¹ãƒˆä¸­...' : 'ğŸ”Œ APIæ¥ç¶šãƒ†ã‚¹ãƒˆ'}
              </button>
            </div>

            {apiStatus === 'success' && (
              <div className="success-message">
                âœ… APIæ¥ç¶šæˆåŠŸï¼ã‚µãƒ¼ãƒãƒ¼ã¨æ­£å¸¸ã«é€šä¿¡ã§ãã¦ã„ã¾ã™ã€‚
              </div>
            )}

            {error && <div className="error-message">{error}</div>}

            {debugInfo && (
              <div className="debug-info">
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>
                <pre style={{marginTop: '8px', fontSize: '11px'}}>{debugInfo}</pre>
              </div>
            )}

            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label className="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input
                  type="email"
                  className="form-input"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  disabled={loading}
                />
              </div>

              <div className="form-group">
                <label className="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input
                  type="password"
                  className="form-input"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  disabled={loading}
                />
              </div>

              <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={loading}>
                {loading ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // ============================================
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    // ============================================

    function Dashboard({ user, onLogout }) {
      const [currentPage, setCurrentPage] = useState('analytics');

      return (
        <div className="dashboard">
          <Sidebar user={user} currentPage={currentPage} onNavigate={setCurrentPage} onLogout={onLogout} />
          <main className="main-content">
            {currentPage === 'analytics' && <AnalyticsPage />}
            {currentPage === 'sales' && <SalesPage />}
            {currentPage === 'products' && <ProductsPage />}
          </main>
        </div>
      );
    }

    // ============================================
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼
    // ============================================

    function Sidebar({ user, currentPage, onNavigate, onLogout }) {
      return (
        <aside className="sidebar">
          <div className="sidebar-header">
            <div className="sidebar-logo">MERRILY</div>
            <div className="user-info">
              <div className="user-avatar">{user.name ? user.name[0] : 'U'}</div>
              <div>
                <div style={{fontWeight: 600, fontSize: '14px'}}>{user.name}</div>
                <div style={{fontSize: '12px', color: 'var(--text-secondary)'}}>{user.department}</div>
              </div>
            </div>
          </div>

          <nav className="sidebar-nav">
            <div className="nav-section">
              <div className="nav-section-title">ä¼šè¨ˆéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
              <div 
                className={`nav-item ${currentPage === 'analytics' ? 'active' : ''}`}
                onClick={() => onNavigate('analytics')}
              >
                <span>ğŸ“Š</span>
                <span>å£²ä¸Šåˆ†æ</span>
              </div>
              <div 
                className={`nav-item ${currentPage === 'sales' ? 'active' : ''}`}
                onClick={() => onNavigate('sales')}
              >
                <span>ğŸ’°</span>
                <span>å£²ä¸Šç®¡ç†</span>
              </div>
              <div 
                className={`nav-item ${currentPage === 'products' ? 'active' : ''}`}
                onClick={() => onNavigate('products')}
              >
                <span>â˜•</span>
                <span>å•†å“ç®¡ç†</span>
              </div>
            </div>
          </nav>

          <div className="sidebar-footer">
            <button className="btn-secondary" style={{width: '100%'}} onClick={onLogout}>
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        </aside>
      );
    }

    // ============================================
    // å£²ä¸Šåˆ†æãƒšãƒ¼ã‚¸
    // ============================================

    function AnalyticsPage() {
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [dateRange, setDateRange] = useState({
        startDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        endDate: new Date().toISOString().split('T')[0]
      });
      const [analytics, setAnalytics] = useState(null);
      const [productAnalytics, setProductAnalytics] = useState([]);
      const [dailySalesData, setDailySalesData] = useState([]);
      const [activeTab, setActiveTab] = useState('overview');
      
      const salesChartRef = useRef(null);
      const productChartRef = useRef(null);
      const salesChartInstance = useRef(null);
      const productChartInstance = useRef(null);

      useEffect(() => {
        loadAnalytics();
      }, [dateRange]);

      useEffect(() => {
        if (activeTab === 'trends' && dailySalesData.length > 0) {
          renderSalesChart();
        }
        if (activeTab === 'products' && productAnalytics.length > 0) {
          renderProductChart();
        }
      }, [activeTab, dailySalesData, productAnalytics]);

      const loadAnalytics = async () => {
        try {
          setLoading(true);
          setError('');

          const [analyticsResult, productResult, dailyResult] = await Promise.all([
            apiCall('getSalesAnalytics', dateRange),
            apiCall('getProductAnalytics', { ...dateRange, limit: 10 }),
            apiCall('getDailySalesData', dateRange)
          ]);

          if (analyticsResult.success) {
            setAnalytics(analyticsResult.data);
          }

          if (productResult.success) {
            setProductAnalytics(productResult.data);
          }

          if (dailyResult.success) {
            setDailySalesData(dailyResult.data);
          }

        } catch (err) {
          setError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const renderSalesChart = () => {
        if (!salesChartRef.current || dailySalesData.length === 0) return;

        if (salesChartInstance.current) {
          salesChartInstance.current.destroy();
        }

        const ctx = salesChartRef.current.getContext('2d');
        
        salesChartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: dailySalesData.map(d => d.date),
            datasets: [
              {
                label: 'å£²ä¸Š',
                data: dailySalesData.map(d => d.sales),
                borderColor: '#2D8B5F',
                backgroundColor: 'rgba(45, 139, 95, 0.1)',
                tension: 0.4,
                fill: true
              },
              {
                label: 'ç²—åˆ©',
                data: dailySalesData.map(d => d.profit),
                borderColor: '#DAA520',
                backgroundColor: 'rgba(218, 165, 32, 0.1)',
                tension: 0.4,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'Â¥' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      };

      const renderProductChart = () => {
        if (!productChartRef.current || productAnalytics.length === 0) return;

        if (productChartInstance.current) {
          productChartInstance.current.destroy();
        }

        const ctx = productChartRef.current.getContext('2d');
        
        productChartInstance.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: productAnalytics.map(p => p.productName),
            datasets: [
              {
                label: 'å£²ä¸Š',
                data: productAnalytics.map(p => p.totalSales),
                backgroundColor: '#2D8B5F'
              },
              {
                label: 'ç²—åˆ©',
                data: productAnalytics.map(p => p.totalProfit),
                backgroundColor: '#DAA520'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'Â¥' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      };

      if (loading) {
        return <div className="loading">èª­ã¿è¾¼ã¿ä¸­...</div>;
      }

      return (
        <div>
          <div className="page-header">
            <h1 className="page-title">å£²ä¸Šåˆ†æ</h1>
          </div>

          {error && <div className="error-message">{error}</div>}

          <div className="filter-group">
            <div className="filter-item">
              <label className="form-label">é–‹å§‹æ—¥</label>
              <input
                type="date"
                className="form-input"
                value={dateRange.startDate}
                onChange={(e) => setDateRange({...dateRange, startDate: e.target.value})}
              />
            </div>
            <div className="filter-item">
              <label className="form-label">çµ‚äº†æ—¥</label>
              <input
                type="date"
                className="form-input"
                value={dateRange.endDate}
                onChange={(e) => setDateRange({...dateRange, endDate: e.target.value})}
              />
            </div>
          </div>

          {analytics && (
            <div className="stats-grid">
              <div className="stat-card">
                <div className="stat-label">ç·å£²ä¸Š</div>
                <div className="stat-value">{formatCurrency(analytics.totalSales)}</div>
                <div className="stat-change positive">
                  {analytics.transactionCount} ä»¶ã®å–å¼•
                </div>
              </div>

              <div className="stat-card">
                <div className="stat-label">ç·ç²—åˆ©</div>
                <div className="stat-value">{formatCurrency(analytics.totalProfit)}</div>
                <div className="stat-change positive">
                  ç²—åˆ©ç‡ {analytics.profitMargin}%
                </div>
              </div>

              <div className="stat-card">
                <div className="stat-label">ç·åŸä¾¡</div>
                <div className="stat-value">{formatCurrency(analytics.totalCost)}</div>
                <div className="stat-change">
                  åŸä¾¡ç‡ {(100 - analytics.profitMargin).toFixed(1)}%
                </div>
              </div>

              <div className="stat-card">
                <div className="stat-label">å¹³å‡å®¢å˜ä¾¡</div>
                <div className="stat-value">{formatCurrency(analytics.averageTransactionValue)}</div>
                <div className="stat-change">
                  è²©å£²æ•°é‡ {analytics.totalQuantity} å€‹
                </div>
              </div>
            </div>
          )}

          <div className="tab-buttons">
            <button 
              className={`tab-button ${activeTab === 'overview' ? 'active' : ''}`}
              onClick={() => setActiveTab('overview')}
            >
              æ¦‚è¦
            </button>
            <button 
              className={`tab-button ${activeTab === 'trends' ? 'active' : ''}`}
              onClick={() => setActiveTab('trends')}
            >
              æ¨ç§»ã‚°ãƒ©ãƒ•
            </button>
            <button 
              className={`tab-button ${activeTab === 'products' ? 'active' : ''}`}
              onClick={() => setActiveTab('products')}
            >
              å•†å“åˆ¥åˆ†æ
            </button>
          </div>

          {activeTab === 'overview' && productAnalytics.length > 0 && (
            <div className="card">
              <div className="card-header">
                <h2 className="card-title">å•†å“åˆ¥å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
              </div>
              <div className="table-container">
                <table className="table">
                  <thead>
                    <tr>
                      <th>é †ä½</th>
                      <th>å•†å“å</th>
                      <th>å£²ä¸Š</th>
                      <th>ç²—åˆ©</th>
                      <th>ç²—åˆ©ç‡</th>
                      <th>è²©å£²æ•°</th>
                      <th>å–å¼•æ•°</th>
                    </tr>
                  </thead>
                  <tbody>
                    {productAnalytics.map((product, index) => (
                      <tr key={index}>
                        <td><strong>{index + 1}</strong></td>
                        <td>{product.productName}</td>
                        <td>{formatCurrency(product.totalSales)}</td>
                        <td>{formatCurrency(product.totalProfit)}</td>
                        <td>
                          <span className={`badge ${product.profitMargin >= 50 ? 'badge-success' : product.profitMargin >= 30 ? 'badge-warning' : 'badge-danger'}`}>
                            {product.profitMargin}%
                          </span>
                        </td>
                        <td>{product.totalQuantity}</td>
                        <td>{product.transactionCount}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {activeTab === 'trends' && (
            <div className="card">
              <div className="card-header">
                <h2 className="card-title">å£²ä¸Šæ¨ç§»</h2>
              </div>
              <div className="chart-container">
                <canvas ref={salesChartRef}></canvas>
              </div>
            </div>
          )}

          {activeTab === 'products' && (
            <div className="card">
              <div className="card-header">
                <h2 className="card-title">å•†å“åˆ¥å£²ä¸Šæ¯”è¼ƒ</h2>
              </div>
              <div className="chart-container">
                <canvas ref={productChartRef}></canvas>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // å£²ä¸Šç®¡ç†ãƒšãƒ¼ã‚¸
    // ============================================

    function SalesPage() {
      const [sales, setSales] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showModal, setShowModal] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [dateRange, setDateRange] = useState({
        startDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        endDate: new Date().toISOString().split('T')[0]
      });

      useEffect(() => {
        loadSales();
      }, [dateRange]);

      const loadSales = async () => {
        try {
          setLoading(true);
          const result = await apiCall('getSalesData', dateRange);

          if (result.success) {
            setSales(result.data || []);
          } else {
            setError(result.message);
          }
        } catch (err) {
          setError('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div>
          <div className="page-header">
            <h1 className="page-title">å£²ä¸Šç®¡ç†</h1>
            <button className="btn-success" onClick={() => setShowModal(true)}>+ å£²ä¸Šã‚’ç™»éŒ²</button>
          </div>

          {error && <div className="error-message">{error}</div>}
          {success && <div className="success-message">{success}</div>}

          <div className="filter-group">
            <div className="filter-item">
              <label className="form-label">é–‹å§‹æ—¥</label>
              <input
                type="date"
                className="form-input"
                value={dateRange.startDate}
                onChange={(e) => setDateRange({...dateRange, startDate: e.target.value})}
              />
            </div>
            <div className="filter-item">
              <label className="form-label">çµ‚äº†æ—¥</label>
              <input
                type="date"
                className="form-input"
                value={dateRange.endDate}
                onChange={(e) => setDateRange({...dateRange, endDate: e.target.value})}
              />
            </div>
          </div>

          <div className="card">
            {loading ? (
              <div className="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            ) : sales.length === 0 ? (
              <div className="empty-state">
                <div className="empty-state-icon">ğŸ’°</div>
                <div>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                <div style={{fontSize: '14px', marginTop: '8px'}}>ã€Œ+ å£²ä¸Šã‚’ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¾ã—ã‚‡ã†</div>
              </div>
            ) : (
              <div className="table-container">
                <table className="table">
                  <thead>
                    <tr>
                      <th>æ—¥ä»˜</th>
                      <th>å•†å“å</th>
                      <th>æ•°é‡</th>
                      <th>å˜ä¾¡</th>
                      <th>å°è¨ˆ</th>
                      <th>åŸä¾¡</th>
                      <th>ç²—åˆ©</th>
                      <th>ç™»éŒ²è€…</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sales.map(sale => (
                      <tr key={sale.id}>
                        <td>{formatDate(sale.date)}</td>
                        <td>{sale.productName}</td>
                        <td>{sale.quantity}</td>
                        <td>{formatCurrency(sale.unitPrice)}</td>
                        <td>{formatCurrency(sale.subtotal)}</td>
                        <td>{formatCurrency(sale.cost * sale.quantity)}</td>
                        <td style={{color: sale.profit >= 0 ? 'var(--merrily-green-dark)' : 'var(--merrily-brown)'}}>
                          {formatCurrency(sale.profit)}
                        </td>
                        <td>{sale.registeredBy}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {showModal && (
            <SalesModal
              onClose={() => setShowModal(false)}
              onSave={() => {
                setShowModal(false);
                loadSales();
                setSuccess('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                setTimeout(() => setSuccess(''), 3000);
              }}
              setError={setError}
            />
          )}
        </div>
      );
    }

    // å£²ä¸Šç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
    function SalesModal({ onClose, onSave, setError }) {
      const [products, setProducts] = useState([]);
      const [selectedProducts, setSelectedProducts] = useState({});
      const [saleDate, setSaleDate] = useState(new Date().toISOString().split('T')[0]);
      const [saving, setSaving] = useState(false);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadProducts();
      }, []);

      const loadProducts = async () => {
        try {
          const result = await apiCall('getProducts');
          if (result.success) {
            setProducts(result.data.filter(p => p.status === 'è²©å£²ä¸­'));
          }
        } catch (err) {
          setError('å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        } finally {
          setLoading(false);
        }
      };

      const handleQuantityChange = (productId, quantity) => {
        setSelectedProducts(prev => ({
          ...prev,
          [productId]: Math.max(0, quantity)
        }));
      };

      const totals = products.reduce((acc, product) => {
        const qty = selectedProducts[product.id] || 0;
        if (qty > 0) {
          acc.subtotal += product.price * qty;
          acc.totalCost += (product.cost || 0) * qty;
          acc.profit += (product.price - (product.cost || 0)) * qty;
        }
        return acc;
      }, { subtotal: 0, totalCost: 0, profit: 0 });

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        const salesItems = products
          .filter(product => selectedProducts[product.id] > 0)
          .map(product => ({
            date: saleDate,
            productId: product.id,
            productName: product.name,
            quantity: selectedProducts[product.id],
            unitPrice: product.price,
            cost: product.cost || 0
          }));

        if (salesItems.length === 0) {
          setError('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }

        setSaving(true);

        try {
          const result = await apiCall('addSalesData', { salesItems });

          if (result.success) {
            onSave();
          } else {
            setError(result.message);
          }
        } catch (err) {
          setError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">å£²ä¸Šç™»éŒ²</h2>
              <button className="modal-close" onClick={onClose}>Ã—</button>
            </div>

            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">è²©å£²æ—¥ *</label>
                  <input
                    type="date"
                    className="form-input"
                    value={saleDate}
                    onChange={(e) => setSaleDate(e.target.value)}
                    required
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">å•†å“é¸æŠ *</label>
                  {loading ? (
                    <div className="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                  ) : (
                    <div className="product-grid">
                      {products.map(product => (
                        <div 
                          key={product.id}
                          className={`product-card ${(selectedProducts[product.id] || 0) > 0 ? 'selected' : ''}`}
                        >
                          <div className="product-name">{product.name}</div>
                          <div className="product-price">{formatCurrency(product.price)}</div>
                          <div className="quantity-control">
                            <button
                              type="button"
                              className="quantity-btn"
                              onClick={() => handleQuantityChange(product.id, (selectedProducts[product.id] || 0) - 1)}
                            >
                              -
                            </button>
                            <input
                              type="number"
                              className="quantity-input"
                              value={selectedProducts[product.id] || 0}
                              onChange={(e) => handleQuantityChange(product.id, parseInt(e.target.value) || 0)}
                              min="0"
                            />
                            <button
                              type="button"
                              className="quantity-btn"
                              onClick={() => handleQuantityChange(product.id, (selectedProducts[product.id] || 0) + 1)}
                            >
                              +
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="summary-box">
                  <div className="summary-row">
                    <span>å°è¨ˆ:</span>
                    <strong>{formatCurrency(totals.subtotal)}</strong>
                  </div>
                  <div className="summary-row">
                    <span>åŸä¾¡åˆè¨ˆ:</span>
                    <span>{formatCurrency(totals.totalCost)}</span>
                  </div>
                  <div className="summary-row total">
                    <span>ç²—åˆ©:</span>
                    <strong style={{color: totals.profit >= 0 ? 'var(--merrily-green-dark)' : 'var(--merrily-brown)'}}>
                      {formatCurrency(totals.profit)}
                    </strong>
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button type="button" className="btn-secondary" onClick={onClose}>
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" className="btn btn-primary" disabled={saving}>
                  {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // å•†å“ç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    function ProductsPage() {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showModal, setShowModal] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');

      useEffect(() => {
        loadProducts();
      }, []);

      const loadProducts = async () => {
        try {
          setLoading(true);
          const result = await apiCall('getProducts');

          if (result.success) {
            setProducts(result.data || []);
          } else {
            setError(result.message);
          }
        } catch (err) {
          setError('å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div>
          <div className="page-header">
            <h1 className="page-title">å•†å“ç®¡ç†</h1>
            <button className="btn-success" onClick={() => setShowModal(true)}>+ å•†å“ã‚’è¿½åŠ </button>
          </div>

          {error && <div className="error-message">{error}</div>}
          {success && <div className="success-message">{success}</div>}

          <div className="card">
            {loading ? (
              <div className="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            ) : products.length === 0 ? (
              <div className="empty-state">
                <div className="empty-state-icon">â˜•</div>
                <div>å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                <div style={{fontSize: '14px', marginTop: '8px'}}>ã€Œ+ å•†å“ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¾ã—ã‚‡ã†</div>
              </div>
            ) : (
              <div className="table-container">
                <table className="table">
                  <thead>
                    <tr>
                      <th>å•†å“å</th>
                      <th>ã‚«ãƒ†ã‚´ãƒª</th>
                      <th>ä¾¡æ ¼</th>
                      <th>åŸä¾¡</th>
                      <th>åŸä¾¡ç‡</th>
                      <th>çŠ¶æ…‹</th>
                    </tr>
                  </thead>
                  <tbody>
                    {products.map(product => (
                      <tr key={product.id}>
                        <td>{product.name}</td>
                        <td>{product.category}</td>
                        <td>{formatCurrency(product.price)}</td>
                        <td>{formatCurrency(product.cost)}</td>
                        <td>{product.costRate}%</td>
                        <td><span className="badge badge-success">{product.status}</span></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {showModal && (
            <ProductModal
              onClose={() => setShowModal(false)}
              onSave={() => {
                setShowModal(false);
                loadProducts();
                setSuccess('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                setTimeout(() => setSuccess(''), 3000);
              }}
              setError={setError}
            />
          )}
        </div>
      );
    }

    // å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
    function ProductModal({ onClose, onSave, setError }) {
      const [formData, setFormData] = useState({
        name: '',
        category: 'ãƒ‰ãƒªãƒ³ã‚¯',
        price: 0,
        cost: 0,
        status: 'è²©å£²ä¸­'
      });
      const [saving, setSaving] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);

        try {
          const result = await apiCall('addProduct', { product: formData });

          if (result.success) {
            onSave();
          } else {
            setError(result.message);
          }
        } catch (err) {
          setError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">å•†å“ã‚’è¿½åŠ </h2>
              <button className="modal-close" onClick={onClose}>Ã—</button>
            </div>

            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">å•†å“å *</label>
                  <input
                    type="text"
                    className="form-input"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    required
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
                    <select
                      className="form-select"
                      value={formData.category}
                      onChange={(e) => setFormData({...formData, category: e.target.value})}
                    >
                      <option>ãƒ‰ãƒªãƒ³ã‚¯</option>
                      <option>ãƒ•ãƒ¼ãƒ‰</option>
                      <option>ãƒ‡ã‚¶ãƒ¼ãƒˆ</option>
                      <option>ãã®ä»–</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label className="form-label">è²©å£²ä¾¡æ ¼ *</label>
                    <input
                      type="number"
                      className="form-input"
                      value={formData.price}
                      onChange={(e) => setFormData({...formData, price: Number(e.target.value)})}
                      required
                      min="0"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">åŸä¾¡</label>
                  <input
                    type="number"
                    className="form-input"
                    value={formData.cost}
                    onChange={(e) => setFormData({...formData, cost: Number(e.target.value)})}
                    min="0"
                  />
                </div>
              </div>

              <div className="modal-footer">
                <button type="button" className="btn-secondary" onClick={onClose}>
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" className="btn btn-primary" disabled={saving}>
                  {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
